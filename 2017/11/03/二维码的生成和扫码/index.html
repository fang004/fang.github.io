<!-- build time:Fri Nov 03 2017 16:59:14 GMT+0800 (CST) --><!DOCTYPE html><html><head><meta charset="UTF-8"><title>二维码的生成和扫码 | 赵芳</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/styles.css"><link rel="shortcut icon" href="/2017/11/03/二维码的生成和扫码/index.html"></head></html><body class="te-body-default"><div class="te-wrap" id="teWrap"><div class="te-left"><div id="menu-outer"><div id="menu-inner"><div class="te-menu-item"><a href="/"><span>赵芳</span></a></div><div class="te-menu-item"><a href="/archives"><span>所有文章</span></a></div><div class="te-menu-item"><a href="https://github.com/fang004"><span>Github</span></a></div></div></div></div><div class="te-right"><div id="content-outer"><div id="content-inner"><article id="post"><h1 class="post-title">二维码的生成和扫码</h1><div class="toc-show" id="tocShow"></div><div class="te-post-outer"><div class="te-post-inner"><h2 id="二维码的生成"><a href="#二维码的生成" class="headerlink" title="二维码的生成"></a>二维码的生成</h2><h3 id="二维码的结构"><a href="#二维码的结构" class="headerlink" title="二维码的结构"></a>二维码的结构</h3><p>建议去<a href="https://www.the-qrcode-generator.com/" target="_blank" rel="external">QR Code Generater</a>网站，在左侧的地址栏里面输入不同的内容，仔细观察右侧二维码图片的变更过程，看图片的变化规则。</p><p><img src="https://raw.githubusercontent.com/fang004/attachment/master/blog/img/2017041101.png" alt="二维码的结构"></p><p>整体分为<strong>功能区</strong>和<strong>编码区</strong></p><ul><li>功能区主要用于<strong>定位</strong></li><li>编码区是<strong>真正存储数据</strong>的</li></ul><p>注意点：</p><ol><li>二维码所有的模块中，储存的并不是我们需要的信息，甚至只有一小部分才是。在上图上，只有<strong>数据和纠错码字</strong>中的<strong>数据</strong>才是我们实际想存储的数据。</li><li><strong>版本信息</strong>：二维码一共有40个版本，不同版本的区别主要是存储数据的模块的多少（每一块黑/白块就是一个模块），模块的数量遵循：<code>moduleCount = 21 + ( n-1 ) × 4</code>，比如：版本1的模块数量是<code>21 × 21</code>，版本40的模块数量为： <code>21 + ( 40 -1 ) × 4 = 177</code>。<ul><li><code>40 × 40</code>大小的矩形有1600个元素，用二进制来作为存储方式的话，就可以存储1600位(bit)，8个bit构成1个”字节(Byte)”，1个字节可以储存1个英文字母或者半个汉字，换句话说，1个汉字占据2个字节的存储空间。1600/8=200字节，/2=100个汉字.</li></ul></li></ol><h3 id="二维码如何生成"><a href="#二维码如何生成" class="headerlink" title="二维码如何生成"></a>二维码如何生成</h3><p><img src="https://raw.githubusercontent.com/fang004/attachment/master/blog/img/2017041102.png" alt="二维码生成"></p><p>上图详细标注出了二维码各个结构生成的顺序</p><ul><li>左：绘制的顺序</li><li>右：绘制点对应的图形</li></ul><p>【例】<strong>定位图形</strong>：到这一步时，整个二维码就已经有了左上角、右中角、左下角、连接这三者的横竖两条定位标志、右下角的校正标志</p><p><strong>掩码图案</strong>：</p><ul><li>到这个阶段，整个二维码其实已经绘制完成 了。</li><li>但如果只是按照实际的信息来绘制，可能会导致 页面上有一大片黑色或一大片白色，而不是我们现在看到的黑白交叉的图片，这样的图形扫码识别困难。</li><li>所以在这一步会再做一步操作：从已有的模板中（模板的黑白是交叉的）选一个，来和生成的二维码图形做异或操作，其中异或操作就是JS中的<code>^运算符</code>。</li></ul><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="1-二维码的黑白色是怎么生成的？"><a href="#1-二维码的黑白色是怎么生成的？" class="headerlink" title="1. 二维码的黑白色是怎么生成的？"></a>1. 二维码的黑白色是怎么生成的？</h3><p>以jquery的二维码生成代码<a href="https://github.com/jeromeetienne/jquery-qrcode" target="_blank" rel="external">jquery-qrcode</a>为例，<a href="https://github.com/jeromeetienne/jquery-qrcode/blob/master/src/jquery.qrcode.js" target="_blank" rel="external">源码</a></p><pre><code>options  = $.extend( {}, {
    render          : &quot;canvas&quot;,
    width           : 256,
    height          : 256,
    typeNumber      : -1,
    correctLevel    : QRErrorCorrectLevel.H,
    background      : &quot;#ffffff&quot;,
    foreground      : &quot;#000000&quot;
}, options);
</code></pre><p>这是生成二维码时的一些参数，其中<code>background</code>和<code>foreground</code>属性，分别为白黑色，即二维码绘制的颜色。</p><p>我们从<a href="http://coolshell.cn/articles/10590.html" target="_blank" rel="external">二维码的生成细节和原理</a>文章可以知道，二维码生成的过程中，会把所有的信息转换成二进制，通过<code>isDark</code>函数，来绘制不同颜色。</p><pre><code>// draw in the canvas
for( var row = 0; row &lt;qrcode.getModuleCount(); row++ ){
    for( var col = 0; col &lt;qrcode.getModuleCount(); col++ ){
        ctx.fillStyle = qrcode.isDark(row, col) ? options.foreground : options.background;
        var w = (Math.ceil((col+1)*tileW) - Math.floor(col*tileW));
        var h = (Math.ceil((row+1)*tileW) - Math.floor(row*tileW));
        ctx.fillRect(Math.round(col*tileW),Math.round(row*tileH), w, h);  
    }    
}
</code></pre><p>我们可以通过修改<code>foreground</code>参数和<code>background</code>参数，来生成自定义颜色的二维码</p><h3 id="2-同样的内容生成的二维码是一样的吗？"><a href="#2-同样的内容生成的二维码是一样的吗？" class="headerlink" title="2. 同样的内容生成的二维码是一样的吗？"></a>2. 同样的内容生成的二维码是一样的吗？</h3><p>不一样，但扫码的结果是一样的。原因是由于具体生成黑白块时，是按照一定的规律随机放置在图片中的。</p><h3 id="3-既然可以生成彩色的，为啥我们平时看到的二维码都是黑白的？"><a href="#3-既然可以生成彩色的，为啥我们平时看到的二维码都是黑白的？" class="headerlink" title="3. 既然可以生成彩色的，为啥我们平时看到的二维码都是黑白的？"></a>3. 既然可以生成彩色的，为啥我们平时看到的二维码都是黑白的？</h3><p>在答案前，我们先来了解一下，<strong>扫码</strong>：</p><p><img src="https://raw.githubusercontent.com/fang004/attachment/master/blog/img/2017041103.png" alt="扫码流程图"></p><p>总的来说，扫码的流程就两步：</p><ol><li>获取二维码图片信息</li><li>对图片信息做相应处理</li></ol><p>无论哪种App里面的扫码功能，其实都是一样，是一个解密的过程，具体解密过程，可看一下<a href="https://github.com/zxing/zxin" target="_blank" rel="external">Zxing的源码</a></p><p>现在咱们来想一下：<strong>为啥我们平时看到的二维码都是黑白的？</strong></p><p>从颜值上来讲，彩色的二维码会更好看，但为啥还用黑白的二维码？</p><p>原因在于：</p><ul><li>黑白二维码扫码的速度更快，对于手机摄像头来说，要读取信息，就是获取图片中的两种二进制信息，在所有的颜色中，只有黑白色的色值相差最大，对手机来说，更容易区分。</li><li></li></ul><h3 id="3-扫码时的速度取决于什么？"><a href="#3-扫码时的速度取决于什么？" class="headerlink" title="3. 扫码时的速度取决于什么？"></a>3. 扫码时的速度取决于什么？</h3><p>从二维码的角度：</p><ol><li>二维码的平整度（大家平时看到的二维码，可以看到二维码是放在一个白色框里面）</li><li>二维码内容的识别度（黑白色）</li><li>存续的信息量大小（以现在手机的处理能力，这个因素影响很小）</li></ol><p>从手机的角度：</p><ol><li>不同的APP针对挚友做的优化措施不一样，比如微信就做了很多优化措施。</li><li>摄像头的硬件配置。</li></ol><h2 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h2><ol><li><a href="https://juejin.im/post/58eb05ffb123db1ad06615c9" target="_blank" rel="external">【科普文】二维码的[生成]和[扫码]</a></li><li><a href="http://coolshell.cn/articles/10590.html" target="_blank" rel="external">二维码的生成细节和原理</a></li><li><a href="https://github.com/zxing/zxing" target="_blank" rel="external">二维码扫码–解密代码：Zxing</a></li></ol></div><div class="post-toc" id="postToc"><div class="toc-outer"><div class="top-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#二维码的生成"><span class="toc-number">1.</span> <span class="toc-text">二维码的生成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#二维码的结构"><span class="toc-number">1.1.</span> <span class="toc-text">二维码的结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二维码如何生成"><span class="toc-number">1.2.</span> <span class="toc-text">二维码如何生成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题"><span class="toc-number">2.</span> <span class="toc-text">问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-二维码的黑白色是怎么生成的？"><span class="toc-number">2.1.</span> <span class="toc-text">1. 二维码的黑白色是怎么生成的？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-同样的内容生成的二维码是一样的吗？"><span class="toc-number">2.2.</span> <span class="toc-text">2. 同样的内容生成的二维码是一样的吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-既然可以生成彩色的，为啥我们平时看到的二维码都是黑白的？"><span class="toc-number">2.3.</span> <span class="toc-text">3. 既然可以生成彩色的，为啥我们平时看到的二维码都是黑白的？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-扫码时的速度取决于什么？"><span class="toc-number">2.4.</span> <span class="toc-text">3. 扫码时的速度取决于什么？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文档："><span class="toc-number">3.</span> <span class="toc-text">参考文档：</span></a></li></ol></div></div></div></article><nav id="pagination"><a href="/2017/11/02/window.performance详解/" class="next"><i class="fa fa-angle-right"></i></a></nav></div></div><script src="/js/scripts.js"></script></div></div><script src="/js/scripts.js"></script></body><!-- rebuild by neat -->